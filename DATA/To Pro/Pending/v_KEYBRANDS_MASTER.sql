USE [godzilla]
GO

/****** Object:  View [dbo].[v_KEYBRANDS_MASTER]    Script Date: 11/10/2016 15:21:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[v_KEYBRANDS_MASTER]
AS
WITH MARKET_MST AS
(SELECT COALESCE (cfg.KEYBRAND, bm.KEYBRANDS) AS ID, fm.NAME AS NAME, COALESCE (cff.KEYBRANDSCFG, cfg.KEYBRANDSCFG) AS CONFIG, bm.ID AS BRAND, bm.MARKET, bm.CHANNEL, bm.[GROUP], 'MARKET' AS [SOURCE]
FROM					 dbo.ROSETTA_LOADER AS r INNER JOIN
                         dbo.BRAND_MASTER AS bm ON bm.MARKET = r.[MARKET ID]  AND bm.ID = r.[BRAND ID] INNER JOIN
						 dbo.KEYBRANDS_MASTER AS fm ON fm.ID = bm.KEYBRANDS INNER JOIN
                         dbo.CALCS_MARKETS_CONFIG AS cfg ON cfg.MARKET = bm.MARKET AND cfg.BRAND = bm.ID LEFT OUTER JOIN
                         dbo.CALCS_MARKETS_CONFIG AS cff ON cff.MARKET <> cff.MARKET AND cff.BRAND <> bm.ID AND cff.KEYBRAND = bm.KEYBRANDS),

BRAND_MST AS
(SELECT COALESCE (cfg.KEYBRAND, bm.KEYBRANDS) AS ID, fm.NAME AS NAME, COALESCE (cff.KEYBRANDSCFG, cfg.KEYBRANDSCFG) AS CONFIG, bm.ID AS BRAND, bm.MARKET, bm.CHANNEL, bm.[GROUP], 'BRAND' AS [SOURCE]
FROM					 dbo.ROSETTA_LOADER AS r INNER JOIN
                         dbo.BRAND_MASTER AS bm ON bm.MARKET = r.[MARKET ID]  AND bm.ID = r.[BRAND ID] INNER JOIN
						 dbo.KEYBRANDS_MASTER AS fm ON fm.ID = bm.KEYBRANDS INNER JOIN
                         dbo.CALCS_BRANDS_CONFIG AS cfg ON cfg.MARKET = bm.MARKET AND cfg.BRAND = bm.ID LEFT OUTER JOIN
                         dbo.CALCS_BRANDS_CONFIG AS cff ON cff.MARKET <> cff.MARKET AND cff.BRAND <> bm.ID AND cff.KEYBRAND = bm.KEYBRANDS)
SELECT DISTINCT  ROW_NUMBER() OVER (ORDER BY mm.[GROUP], mm.MARKET, mm.BRAND, mm.ID) AS ROW_ID, mm.ID, mm.NAME, mm.BRAND, mm.MARKET, mm.CHANNEL, mm.[GROUP], mm.CONFIG AS [CONFIG MARKET], bm.CONFIG AS [CONFIG BRAND]
	FROM	MARKET_MST AS mm INNER JOIN
			BRAND_MST AS bm ON bm.ID = mm.ID AND bm.BRAND = mm.BRAND AND bm.MARKET = mm.MARKET
GO


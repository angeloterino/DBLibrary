USE [godzilla]
GO

/****** Object:  View [dbo].[v_WRK_BOY_YTD_GROUP]    Script Date: 10/10/2016 9:56:55 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO







ALTER VIEW [dbo].[v_WRK_BOY_YTD_GROUP]
AS
WITH BOY_DATA AS (
SELECT DISTINCT
                         bm.CHANNEL AS CHANNEL, bc.NTS_ORDER, bm.[GROUP] AS [GROUP], mm.ID AS MARKET,bm.ID AS BRAND
						 , COALESCE(mm.NAME,bm.NAME) AS [MARKET NAME], bm.NAME AS [BRAND NAME], COALESCE(bc.NTS_NAME,bm.NAME) AS NTS_NAME, 
                         COALESCE(vby.[YTD COL1],0) AS [SELLOUT COL1], COALESCE(vby.[YTD COL2],0) AS [SELLOUT COL2],
						 COALESCe(vmy.[YTD COL1],0) AS [MARKET COL1], COALESCE(vmy.[YTD COL2],0) AS [MARKET COL2], 
						 CONVERT(DECIMAL(22, 0), (COALESCE (nts.YTD_AMOUNT_PY, 0) * 1000)) AS [SELLIN COL1],
						 CONVERT(DECIMAL(22, 0), (COALESCE (nts.YTD_AMOUNT_ACTUAL, 0) * 1000)) AS [SELLIN COL2] 
						 , p.YEAR_PERIOD AS [YEAR PERIOD], p.MONTH_PERIOD AS [MONTH PERIOD]
FROM					 godzilla.dbo.ROSETTA_LOADER AS ros INNER JOIN
						 godzilla.dbo.BRAND_MASTER AS bm ON bm.ID = ros.[BRAND ID] AND bm.MARKET = ros.[MARKET ID] INNER JOIN
						 godzilla.dbo.MARKET_MASTER AS mm ON mm.ID = bm.MARKET LEFT JOIN
						 godzilla.dbo.BOY_CONFIG AS bc ON bc.MARKET = bm.MARKET AND bc.BRAND = bm.ID AND bc.CHANNEL = bm.CHANNEL INNER JOIN
						 godzilla.dbo.PERIOD_TABLE AS p ON 1= 1 LEFT JOIN
                         godzilla.dbo.WRK_NTS_BOY AS nts ON nts.CHANNEL = bm.CHANNEL AND nts.BRAND = bm.ID AND nts.MARKET = bm.MARKET
						 AND nts.[YEAR PERIOD] = p.YEAR_PERIOD AND nts.[MONTH PERIOD] = p.MONTH_PERIOD LEFT JOIN
						 godzilla.dbo.WRK_BRAND_YTD AS vby ON vby.BRAND = bm.ID AND vby.MARKET = bm.MARKET AND vby.CHANNEL = bm.CHANNEL 
						 AND vby.[YEAR PERIOD] = p.YEAR_PERIOD AND vby.[MONTH PERIOD] = p.MONTH_PERIOD LEFT JOIN
                         godzilla.dbo.WRK_MARKET_YTD AS vmy ON vmy.MARKET = bm.MARKET AND vmy.BRAND = bm.ID AND vmy.CHANNEL = bm.CHANNEL AND 
                         vmy.[YEAR PERIOD] = vby.[YEAR PERIOD] AND vmy.[MONTH PERIOD] = vby.[MONTH PERIOD] )
SELECT CHANNEL, NTS_ORDER, [GROUP], MARKET, BRAND, NTS_NAME, NULL AS [MARKET NAME],NULL AS [BRAND NAME],[YEAR PERIOD],[MONTH PERIOD],
		[MARKET COL1], 
		[MARKET COL2], 
		[MARKET PC],
		[SELLIN COL1], 
		[SELLIN COL2], 
		[SELLIN PC],
		[SELLOUT COL1],
		[SELLOUT COL2],
		[SELLOUT PC]
FROM (
	SELECT  
						 1 AS GROUPED,
                         MAX(data.[CHANNEL]) AS CHANNEL
						 , MAX(data.NTS_ORDER) AS [NTS_ORDER], MAX(data.[GROUP])  AS [GROUP], 
						 MAX(data.MARKET) + MAX(m.BASE_ID) AS MARKET, 
						 MAX(data.[BRAND]) + MAX(m.BASE_ID) AS BRAND,
						 m.NAME AS NTS_NAME,
                         SUM(data.[SELLOUT COL1]) AS [SELLOUT COL1], 
						 SUM(data.[SELLOUT COL2]) AS [SELLOUT COL2], 
						 CASE WHEN SUM(data.[SELLOUT COL1]) = 0 THEN 0 ELSE 
							CONVERT(DECIMAL(10, 2), (SUM(data.[SELLOUT COL2]) / SUM(data.[SELLOUT COL1]) - 1) * 100)
						 END AS [SELLOUT PC], 
						 SUM(data.[MARKET COL1]) AS [MARKET COL1], 
						 SUM(data.[MARKET COL2]) AS [MARKET COL2], 
						 CASE WHEN SUM(data.[MARKET COL1]) = 0 THEN 0 ELSE 
							CONVERT(DECIMAL(10, 2), (SUM(data.[MARKET COL2]) / SUM(data.[MARKET COL1]) - 1) * 100)
						 END AS [MARKET PC], 
						 SUM(data.[SELLIN COL1]) AS [SELLIN COL1],
						 SUM(data.[SELLIN COL2]) AS [SELLIN COL2],
						 CASE WHEN SUM(data.[SELLIN COL1]) = 0 THEN 0 ELSE 
							CONVERT(DECIMAL(10, 2), (SUM(data.[SELLIN COL2]) / SUM(data.[SELLIN COL1]) - 1) * 100)
						 END AS [SELLIN PC], data.[YEAR PERIOD], data.[MONTH PERIOD]
FROM					GROUP_MASTER AS m INNER JOIN
						GROUP_CONFIG AS c ON c.TYPE_ID = m.TYPE AND c.GROUP_ID = m.ID AND m.TYPE = 21 INNER JOIN
						BOY_DATA AS data ON data.MARKET = c.MARKET AND data.BRAND = c.BRAND AND data.NTS_ORDER IS NOT NULL
GROUP BY  c.GROUP_ID, m.NAME, data.[YEAR PERIOD], data.[MONTH PERIOD]) AS DTA







GO



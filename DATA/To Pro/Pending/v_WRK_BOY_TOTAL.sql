USE [godzilla]
GO

/****** Object:  View [dbo].[v_WRK_BOY_TOTAL]    Script Date: 10/10/2016 9:51:13 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER VIEW [dbo].[v_WRK_BOY_TOTAL]
AS
WITH BOY_DATA AS (
SELECT DISTINCT 
                         bm.CHANNEL AS CHANNEL, bc.NTS_ORDER, bm.[GROUP] AS [GROUP], mm.ID AS MARKET,bm.ID AS BRAND,
						 COALESCE(bc.MARKET_CONFIG,1) AS MARKET_CONFIG, COALESCE(bc.SELLOUT_CONFIG,1) AS SELLOUT_CONFIG, COALESCE(bc.SELLIN_CONFIG,1) AS SELLIN_CONFIG, COALESCE(bc.CONSOLIDATE,1) AS CONSOLIDATE,
                         vby.[TWO AGO] AS [SELLOUT COL1], vby.[LAST] AS [SELLOUT COL2],
						 vmy.[TWO AGO] AS [MARKET COL1], vmy.[LAST] AS [MARKET COL2], 
						 CONVERT(DECIMAL(22, 0), (COALESCE (ntst.YTD_AMOUNT_PY, 0) * 1000)) AS [SELLIN COL1],
						 CONVERT(DECIMAL(22, 0), (COALESCE (ntst.YTD_AMOUNT_ACTUAL, 0) * 1000)) AS [SELLIN COL2] 
						 , p.YEAR_PERIOD AS [YEAR PERIOD], p.MONTH_PERIOD AS [MONTH PERIOD]
FROM					 godzilla.dbo.ROSETTA_LOADER AS ros INNER JOIN
						 godzilla.dbo.BRAND_MASTER AS bm ON bm.ID = ros.[BRAND ID] AND bm.MARKET = ros.[MARKET ID] INNER JOIN
						 godzilla.dbo.MARKET_MASTER AS mm ON mm.ID = bm.MARKET INNER JOIN
						 godzilla.dbo.PERIOD_TABLE AS p ON 1 = 1 LEFT JOIN
						 godzilla.dbo.WRK_BRAND_TOTAL AS vby ON vby.BRAND = bm.ID AND vby.MARKET = bm.MARKET AND vby.CHANNEL = bm.CHANNEL 
						 AND vby.[YEAR PERIOD] = p.YEAR_PERIOD AND vby.[MONTH PERIOD] = p.MONTH_PERIOD LEFT JOIN
                         godzilla.dbo.WRK_MARKET_TOTAL AS vmy ON vmy.MARKET = bm.MARKET AND vmy.BRAND = bm.ID AND vmy.CHANNEL = bm.CHANNEL AND 
                         vmy.[YEAR PERIOD] = vby.[YEAR PERIOD] AND vmy.[MONTH PERIOD] = vby.[MONTH PERIOD] LEFT JOIN
						 godzilla.dbo.BOY_CONFIG AS bc ON bc.MARKET = bm.MARKET AND bc.BRAND = bm.ID AND bc.CHANNEL = bm.CHANNEL LEFT JOIN
						 godzilla.dbo.WRK_NTS_BOY AS nts ON nts.CHANNEL = bm.CHANNEL AND nts.BRAND = bm.ID AND nts.MARKET = bm.MARKET 
						 AND nts.[YEAR PERIOD] = p.YEAR_PERIOD AND nts.[MONTH PERIOD] = p.MONTH_PERIOD LEFT JOIN
						 godzilla.dbo.WRK_NTS_BOY AS ntst ON ntst.CHANNEL = bm.CHANNEL AND ntst.BRAND = bm.ID AND ntst.MARKET = bm.MARKET
						 AND ntst.[MONTH PERIOD] = 12 AND ntst.[YEAR PERIOD] = nts.[YEAR PERIOD] - 1)
SELECT CHANNEL,NTS_ORDER, [GROUP], BRAND, MARKET, [YEAR PERIOD], [MONTH PERIOD], 
		CASE GROUPED WHEN 0 THEN [MARKET COL1] ELSE [MARKET COL1 GRP] END AS [MARKET COL1], 
		CASE GROUPED WHEN 0 THEN [MARKET COL2] ELSE [MARKET COL2 GRP] END AS [MARKET COL2], 
		CASE GROUPED WHEN 0 THEN [MARKET PC] ELSE CASE [MARKET COL1 GRP] WHEN 0 THEN 0 ELSE 
			CONVERT(DECIMAL(18,2),([MARKET COL2 GRP]/[MARKET COL1 GRP] -1) * 100) END END [MARKET PC],
		CASE GROUPED WHEN 0 THEN [SELLIN COL1] ELSE [SELLIN COL1 GRP] END AS [SELLIN COL1], 
		CASE GROUPED WHEN 0 THEN [SELLIN COL2] ELSE [SELLIN COL2 GRP] END AS [SELLIN COL2], 
		CASE GROUPED WHEN 0 THEN [SELLIN PC] ELSE CASE [SELLIN COL1] WHEN 0 THEN 0 ELSE 
			CONVERT(DECIMAL(18,2),([SELLIN COL2]/[SELLIN COL1] -1) * 100) END END AS [SELLIN PC],
		CASE GROUPED WHEN 0 THEN [SELLOUT COL1] ELSE [SELLOUT COL1 GRP] END AS [SELLOUT COL1],
		CASE GROUPED WHEN 0 THEN [SELLOUT COL2] ELSE [SELLOUT COL2 GRP] END AS [SELLOUT COL2],
		CASE GROUPED WHEN 0 THEN [SELLOUT PC] ELSE CASE [SELLOUT COL1] WHEN 0 THEN 0 ELSE 
			CONVERT(DECIMAL(18,2),([SELLOUT COL2]/[SELLOUT COL1] -1) * 100) END END AS [SELLOUT PC]
	
	FROM (
	SELECT  
						 CASE WHEN BRAND IS NULL AND MARKET IS NULL THEN 1 ELSE 0 END AS GROUPED,
                         CASE WHEN NTS_ORDER IS NULL OR (BRAND IS NULL AND MARKET IS NULL AND CONSOLIDATE = 0) THEN NULL ELSE MAX([CHANNEL]) END AS CHANNEL
						 , MAX(NTS_ORDER) AS [NTS_ORDER], MAX([GROUP])  AS [GROUP], 
						 COALESCE(MARKET,MAX(MARKET) + 9000) AS MARKET, 
						 COALESCE(BRAND,MAX([BRAND]) + 9000) AS BRAND,
                         SUM([SELLOUT COL1]) AS [SELLOUT COL1], 
						 SUM([SELLOUT COL2]) AS [SELLOUT COL2], 
                         SUM(COALESCE([SELLOUT COL1],0) * SELLOUT_CONFIG) AS [SELLOUT COL1 GRP], 
						 SUM(COALESCE([SELLOUT COL2],0) * SELLOUT_CONFIG) AS [SELLOUT COL2 GRP], 
						 CASE WHEN SUM([SELLOUT COL1]) = 0 THEN 0 ELSE 
							CONVERT(DECIMAL(10, 2), (SUM([SELLOUT COL2]) / SUM([SELLOUT COL1]) - 1) * 100)
						 END AS [SELLOUT PC], 
						 SUM([MARKET COL1]) AS [MARKET COL1], 
						 SUM([MARKET COL2]) AS [MARKET COL2], 
						 SUM(COALESCE([MARKET COL1],0) * MARKET_CONFIG) AS [MARKET COL1 GRP], 
						 SUM(COALESCE([MARKET COL2],0) * MARKET_CONFIG) AS [MARKET COL2 GRP], 
						 CASE WHEN sum([MARKET COL1]) = 0 THEN 0 ELSE 
							CONVERT(DECIMAL(10, 2), (sum([MARKET COL2]) / sum([MARKET COL1]) - 1) * 100)
						 END AS [MARKET PC], 
						 SUM([SELLIN COL1]) AS [SELLIN COL1],
						 SUM([SELLIN COL2]) AS [SELLIN COL2],
						 SUM(COALESCE([SELLIN COL1],0) * SELLIN_CONFIG) AS [SELLIN COL1 GRP],
						 SUM(COALESCE([SELLIN COL2],0) * SELLIN_CONFIG) AS [SELLIN COL2 GRP],
						 CASE WHEN SUM([SELLIN COL1]) = 0 THEN 0 ELSE 
							CONVERT(DECIMAL(10, 2), (SUM([SELLIN COL2]) / SUM([SELLIN COL1]) - 1) * 100)
						 END AS [SELLIN PC], [YEAR PERIOD], [MONTH PERIOD]
FROM					 BOY_DATA WHERE NTS_ORDER IS NOT NULL
GROUP BY  ROLLUP   ((NTS_ORDER, CONSOLIDATE),(BRAND, MARKET, CHANNEL)),[YEAR PERIOD], [MONTH PERIOD]) AS DTA
WHERE DTA.CHANNEL IS NOT NULL


GO



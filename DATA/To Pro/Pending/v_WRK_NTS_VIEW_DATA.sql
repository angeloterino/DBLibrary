USE [godzilla]
GO

/****** Object:  View [dbo].[v_WRK_NTS_VIEW_DATA]    Script Date: 10/12/2016 6:49:18 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





ALTER VIEW [dbo].[v_WRK_NTS_VIEW_DATA]
AS
WITH DATA AS 
(
SELECT   DISTINCT    COALESCE(mstr.[CHANNEL ID], aux.[CHANNEL ID]) AS CHANNEL,  COALESCE(mstr.[MARKET ID], aux.[MARKET ID]) AS MARKET, COALESCE(mstr.[BRAND ID], aux.[BRAND ID]) AS BRAND, bst.NAME, bst.[GROUP], bst.SUPER_GROUP, data.[SELLIN COL1], bta.[YEAR PERIOD], bta.[MONTH PERIOD], data.TYPE
FROM            ROSETTA_LOADER AS mstr LEFT JOIN
				ROSETTA_LOADER AS aux ON aux.[EXCEL ROW] = mstr.[EXCEL ROW] AND aux.[BRAND ID]!= mstr.[BRAND ID] INNER JOIN
                         BRAND_MASTER AS bst ON bst.MARKET = mstr.[MARKET ID] AND bst.ID = mstr.[BRAND ID] INNER JOIN
						 dbo.STRWM_MARKET_DATA AS bta ON bta.MARKET =bst.MARKET  AND bta.[GROUP] = bst.[GROUP] LEFT JOIN
                         WRK_BOY_DATA AS data ON 
							(data.MARKET = mstr.[MARKET ID] OR data.MARKET= aux.[MARKET ID]) AND 
							(data.BRAND = mstr.[BRAND ID] OR data.BRAND = aux.[BRAND ID]) AND 
							(data.CHANNEL = mstr.[CHANNEL ID] OR data.CHANNEL = aux.[CHANNEL ID]) 
						 AND data.[YEAR PERIOD] = bta.[YEAR PERIOD] AND data.[MONTH PERIOD] = bta.[MONTH PERIOD]
						 WHERE data.BRAND < 9000 and data.MARKET < 9000)
SELECT (CHANNEL * 10000000000000 + BRAND * 10000000) + [YEAR PERIOD] * 100 + [MONTH PERIOD] AS ID,CHANNEL, MARKET, BRAND, [GROUP] - 1 AS [GROUP], [GROUP] AS [GROUP ORDER], [SELLIN COL1] AS AMOUNT, [YEAR PERIOD], [MONTH PERIOD], TYPE
FROM            DATA AS DATA_1
UNION ALL
SELECT (CHANNEL * 10000000000000 + (MAX(BRAND) + 9000) * 10000000) + [YEAR PERIOD] * 100 + [MONTH PERIOD] AS ID,CHANNEL, MAX(MARKET) + 9000 AS MARKET, MAX(BRAND) + 9000 AS BRAND, [GROUP], [GROUP] AS [GROUP ORDER], SUM([SELLIN COL1]) AS AMOUNT, [YEAR PERIOD], [MONTH PERIOD], 
                        TYPE
FROM 
	(SELECT        data.CHANNEL, data.MARKET, data.BRAND AS BRAND,data.[GROUP], data.[SELLIN COL1] * COALESCE (CFG.GROUPCFG, 0) AS [SELLIN COL1], data.[YEAR PERIOD], data.[MONTH PERIOD], data.TYPE
			FROM            dbo.[CALCS_MARKETS_CONFIG] AS CFG LEFT JOIN
							DATA AS data ON data.MARKET = CFG.MARKET AND data.BRAND = CFG.BRAND)
				AS GRP_DATA_1
GROUP BY CHANNEL, [GROUP], [YEAR PERIOD], [MONTH PERIOD], TYPE
UNION ALL
SELECT  
		(CHANNEL * 10000000000000 + MAX(BRAND) * 10000000) + [YEAR PERIOD] * 100 + [MONTH PERIOD] AS ID,CHANNEL, MAX(MARKET) AS MARKET, MAX(BRAND) AS BRAND, MAX([GROUP]) AS GROUP_ORDER, MAX([GROUP]) AS [GROUP], SUM([SELLIN COL1]) AS [YTD COL1], [YEAR PERIOD], [MONTH PERIOD], 
		TYPE
FROM 
	(SELECT        data.CHANNEL, data.MARKET + mst.BASE_ID AS [MARKET], data.BRAND+ mst.BASE_ID AS [BRAND], data.[GROUP], data.[SELLIN COL1] * COALESCE (gcfg.CONFIG, 0) AS [SELLIN COL1], data.[YEAR PERIOD], data.[MONTH PERIOD], data.TYPE
			FROM            dbo.GROUP_CONFIG AS gcfg INNER JOIN
							dbo.GROUP_MASTER AS mst ON mst.TYPE = gcfg.TYPE_ID AND mst.ID = gcfg.GROUP_ID AND mst.TYPE = 6 LEFT JOIN
							DATA AS data ON data.MARKET = gcfg.MARKET AND data.BRAND = gcfg.BRAND)
				AS CUSTOM_DATA_1
GROUP BY CHANNEL, [YEAR PERIOD], [MONTH PERIOD], TYPE
UNION ALL
SELECT  
        (CHANNEL * 10000000000000 +  (MAX(BRAND) + 9900) * 10000000) + [YEAR PERIOD] * 100 + [MONTH PERIOD] AS ID,CHANNEL, MAX(MARKET) + 9900 AS MARKET, MAX(BRAND) + 9900 AS BRAND, MAX([GROUP]) AS [GROUP], SUPER_GROUP AS [GROUP ORDER], SUM([SELLIN COL1]) AS AMOUNT, [YEAR PERIOD], 
        [MONTH PERIOD], TYPE
FROM            
	(SELECT        data.CHANNEL, data.MARKET, data.BRAND AS BRAND,data.[GROUP], data.[SELLIN COL1] * COALESCE (CFG.SUPERCFG, 0) AS [SELLIN COL1], data.[YEAR PERIOD], data.[MONTH PERIOD], data.TYPE, data.SUPER_GROUP
			FROM            dbo.[CALCS_BRANDS_CONFIG] AS CFG LEFT JOIN
							DATA AS data ON data.MARKET = CFG.MARKET AND data.BRAND = CFG.BRAND )
				AS SUPER_DATA_1
GROUP BY CHANNEL, SUPER_GROUP, [YEAR PERIOD], [MONTH PERIOD], TYPE
UNION ALL
SELECT        
		 (CHANNEL * 10000000000000) + (BRAND * 10000000) + ([YEAR PERIOD] * 100) + [MONTH PERIOD] AS ID, [CHANNEL],  [MARKET], [BRAND], [GROUP] AS [GROUP], [GROUP] - 1 AS GROUP_ORDER,
                        ([SELLIN COL1]) AS AMOUNT, [YEAR PERIOD], [MONTH PERIOD], TYPE
FROM 
	(SELECT        MAX(CHANNEL) AS CHANNEL, CUSTOM, MAX([GROUP]) AS [GROUP], SUM([SELLIN COL1]) AS [SELLIN COL1], MAX(MARKET) AS MARKET, MAX(BRAND) AS BRAND, [YEAR PERIOD], [MONTH PERIOD], 
									[GROUP TYPE], [GROUP TYPE ID], TYPE
		FROM            (
		SELECT        data.CHANNEL, mst.ID * 1000 AS CUSTOM, mst.NAME, data.MARKET + mst.BASE_ID AS [MARKET], data.BRAND + mst.BASE_ID AS [BRAND], data.[GROUP], data.[SELLIN COL1] * COALESCE (gcfg.CONFIG, 0) AS [SELLIN COL1], data.[YEAR PERIOD], data.[MONTH PERIOD], data.TYPE,
					typ.NAME AS [GROUP TYPE], typ.ID AS [GROUP TYPE ID]
		 FROM            dbo.GROUP_CONFIG AS gcfg INNER JOIN
                         dbo.GROUP_MASTER AS mst ON mst.TYPE = gcfg.TYPE_ID AND mst.ID = gcfg.GROUP_ID INNER JOIN
                         dbo.GROUP_TYPES AS typ ON typ.ID = mst.TYPE LEFT JOIN
                         DATA AS data ON data.MARKET = gcfg.MARKET AND data.BRAND = gcfg.BRAND
						 WHERE typ.ID IN(15,16) )AS DTA
      GROUP BY CUSTOM, NAME, [YEAR PERIOD], [MONTH PERIOD], [GROUP TYPE], [GROUP TYPE ID], TYPE) AS WC_DATA
UNION ALL
SELECT  
        (CHANNEL * 10000000000000 + 999999999) + [YEAR PERIOD] * 100 + [MONTH PERIOD] AS ID,CHANNEL, MAX(MARKET) AS MARKET, MAX(BRAND) AS BRAND, MAX([GROUP]) AS [GROUP], MAX([GROUP]) + 1 AS [GROUP ORDER], SUM([SELLIN COL1]) AS AMOUNT, [YEAR PERIOD], 
        [MONTH PERIOD], TYPE
FROM            
	(SELECT        data.CHANNEL, 900000 + data.MARKET AS [MARKET],  900000 + data.BRAND AS BRAND, data.[GROUP], data.[SELLIN COL1] * COALESCE (CFG.CHANNELCFG, 0) AS [SELLIN COL1], data.[YEAR PERIOD], data.[MONTH PERIOD], data.TYPE
		FROM            dbo.[CALCS_MARKETS_CONFIG] AS CFG LEFT JOIN
                        DATA AS data ON data.MARKET = CFG.MARKET AND data.BRAND = CFG.BRAND)
					AS CHANNEL_DATA_1
GROUP BY CHANNEL, [YEAR PERIOD], [MONTH PERIOD], TYPE
UNION ALL
SELECT        
		(CHANNEL * 1000000000000) + (BRAND * 10000) + ([YEAR PERIOD] * 100) + [MONTH PERIOD] AS ID, [CHANNEL], [MARKET], [BRAND], [GROUP] AS [GROUP], [GROUP] + 1 AS GROUP_ORDER, 
                ([SELLIN COL1]) AS AMOUNT, [YEAR PERIOD], [MONTH PERIOD], TYPE
FROM           
	(SELECT        (CHANNEL) AS CHANNEL, CUSTOM, MAX([GROUP]) AS [GROUP], SUM([SELLIN COL1]) AS [SELLIN COL1], MAX(MARKET) AS MARKET, MAX(BRAND) AS BRAND, [YEAR PERIOD], [MONTH PERIOD], 
                                [GROUP TYPE], [GROUP TYPE ID], TYPE FROM (
		SELECT         COALESCE (v.VALUE, data.CHANNEL) AS CHANNEL, mst.ID * 1000 AS CUSTOM, mst.NAME, data.MARKET + typ.BASE_ID AS [MARKET], data.BRAND + typ.BASE_ID AS [BRAND], data.[GROUP], data.[SELLIN COL1] * COALESCE (gcfg.CONFIG, 0) AS [SELLIN COL1], data.[YEAR PERIOD], data.[MONTH PERIOD], data.TYPE,
						typ.NAME AS [GROUP TYPE], typ.ID AS [GROUP TYPE ID]
		FROM             dbo.GROUP_CONFIG AS gcfg INNER JOIN
                         dbo.GROUP_MASTER AS mst ON mst.TYPE = gcfg.TYPE_ID AND mst.ID = gcfg.GROUP_ID INNER JOIN
                         dbo.GROUP_TYPES AS typ ON typ.ID = mst.TYPE LEFT JOIN
						 dbo.WRK_VIEWS_VARIABLES AS v ON v.NAME = mst.NAME AND v.[VIEW] = 'CHANNEL' INNER JOIN
                         DATA AS data ON data.MARKET = gcfg.MARKET AND data.BRAND = gcfg.BRAND
						 WHERE typ.ID IN(18) )AS DTA
GROUP BY CHANNEL, CUSTOM, NAME, [YEAR PERIOD], [MONTH PERIOD], [GROUP TYPE], [GROUP TYPE ID], TYPE) AS WC_CHANNEL_DATA


GO



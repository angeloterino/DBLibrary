USE [godzilla]
GO

/****** Object:  View [dbo].[v_WRK_BOY_TOTAL_GROUP]    Script Date: 10/10/2016 10:06:06 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





ALTER VIEW [dbo].[v_WRK_BOY_TOTAL_GROUP]
AS
WITH BOY_DATA AS (
SELECT DISTINCT 
                         bm.CHANNEL AS CHANNEL, bc.NTS_ORDER, bm.[GROUP] AS [GROUP], mm.ID AS MARKET,bm.ID AS BRAND,
                         COALESCE(vby.[TWO AGO],0) AS [SELLOUT COL1], COALESCE(vby.[LAST],0) AS [SELLOUT COL2],
						 COALESCE(vmy.[TWO AGO],0) AS [MARKET COL1], COALESCE(vmy.[LAST],0) AS [MARKET COL2], 
						 CONVERT(DECIMAL(22, 0), (COALESCE (nts.YTD_AMOUNT_PY, 0) * 1000)) AS [SELLIN COL1],
						 CONVERT(DECIMAL(22, 0), (COALESCE (nts.YTD_AMOUNT_ACTUAL, 0) * 1000)) AS [SELLIN COL2] 
						 , p.YEAR_PERIOD AS [YEAR PERIOD], p.MONTH_PERIOD AS [MONTH PERIOD]
FROM					 godzilla.dbo.ROSETTA_LOADER AS ros INNER JOIN
						 godzilla.dbo.BRAND_MASTER AS bm ON bm.ID = ros.[BRAND ID] AND bm.MARKET = ros.[MARKET ID] INNER JOIN
						 godzilla.dbo.MARKET_MASTER AS mm ON mm.ID = bm.MARKET INNER JOIN
						 godzilla.dbo.PERIOD_TABLE AS p ON 1 = 1 LEFT JOIN
						 godzilla.dbo.WRK_BRAND_TOTAL AS vby ON vby.BRAND = bm.ID AND vby.MARKET = bm.MARKET AND vby.CHANNEL = bm.CHANNEL 
						 AND vby.[YEAR PERIOD] = p.YEAR_PERIOD AND vby.[MONTH PERIOD] = p.MONTH_PERIOD LEFT JOIN
                         godzilla.dbo.WRK_MARKET_TOTAL AS vmy ON vmy.MARKET = bm.MARKET AND vmy.BRAND = bm.ID AND vmy.CHANNEL = bm.CHANNEL AND 
                         vmy.[YEAR PERIOD] = vby.[YEAR PERIOD] AND vmy.[MONTH PERIOD] = vby.[MONTH PERIOD] LEFT JOIN
						 godzilla.dbo.BOY_CONFIG AS bc ON bc.MARKET = bm.MARKET AND bc.BRAND = bm.ID AND bc.CHANNEL = bm.CHANNEL LEFT JOIN
						 godzilla.dbo.WRK_NTS_BOY AS nts ON nts.CHANNEL = bm.CHANNEL AND nts.BRAND = bm.ID AND nts.MARKET = bm.MARKET 
						 AND nts.[YEAR PERIOD] = p.YEAR_PERIOD AND nts.[MONTH PERIOD] = p.MONTH_PERIOD LEFT JOIN
						 godzilla.dbo.WRK_NTS_BOY AS ntst ON ntst.CHANNEL = bm.CHANNEL AND ntst.BRAND = bm.ID AND ntst.MARKET = bm.MARKET
						 AND ntst.[MONTH PERIOD] = 12 AND ntst.[YEAR PERIOD] = nts.[YEAR PERIOD] - 1)
SELECT CHANNEL,NTS_ORDER, [GROUP], BRAND, MARKET, [YEAR PERIOD], [MONTH PERIOD], 
		[MARKET COL1],[MARKET COL2],[MARKET PC],
		[SELLIN COL1],[SELLIN COL2],[SELLIN PC],
		[SELLOUT COL1], [SELLOUT COL2],[SELLOUT PC]
	
	FROM (
	SELECT  
						 1 AS GROUPED,
                         MAX([CHANNEL]) AS CHANNEL
						 , MAX(NTS_ORDER) AS [NTS_ORDER], MAX([GROUP])  AS [GROUP], 
						 MAX(data.MARKET) + MAX(m.BASE_ID) AS MARKET, 
						 MAX(data.[BRAND]) + MAX(m.BASE_ID) AS BRAND,
                         SUM([SELLOUT COL1]) AS [SELLOUT COL1], 
						 SUM([SELLOUT COL2]) AS [SELLOUT COL2], 
						 CASE WHEN SUM([SELLOUT COL1]) = 0 THEN 0 ELSE 
							CONVERT(DECIMAL(10, 2), (SUM([SELLOUT COL2]) / SUM([SELLOUT COL1]) - 1) * 100)
						 END AS [SELLOUT PC], 
						 SUM([MARKET COL1]) AS [MARKET COL1], 
						 SUM([MARKET COL2]) AS [MARKET COL2], 
						 CASE WHEN sum([MARKET COL1]) = 0 THEN 0 ELSE 
							CONVERT(DECIMAL(10, 2), (sum([MARKET COL2]) / sum([MARKET COL1]) - 1) * 100)
						 END AS [MARKET PC], 
						 SUM([SELLIN COL1]) AS [SELLIN COL1],
						 SUM([SELLIN COL2]) AS [SELLIN COL2],
						 CASE WHEN SUM([SELLIN COL1]) = 0 THEN 0 ELSE 
							CONVERT(DECIMAL(10, 2), (SUM([SELLIN COL2]) / SUM([SELLIN COL1]) - 1) * 100)
						 END AS [SELLIN PC], [YEAR PERIOD], [MONTH PERIOD]
FROM					GROUP_MASTER AS m INNER JOIN
						GROUP_CONFIG AS c ON c.TYPE_ID = m.TYPE AND c.GROUP_ID = m.ID AND m.TYPE = 21 INNER JOIN
						BOY_DATA AS data ON data.MARKET = c.MARKET AND data.BRAND = c.BRAND AND data.NTS_ORDER IS NOT NULL
GROUP BY  c.GROUP_ID, data.[YEAR PERIOD], data.[MONTH PERIOD]) AS DTA



GO


